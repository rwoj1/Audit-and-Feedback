<!-- ✅ HTML SECTION -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<div class="container">
  <h1>Medicine Prescribing Audit</h1>
  <div class="form-group">
    <label for="practiceLevel">Type of data:</label>
    <select id="practiceLevel">
      <option value="">Select...</option>
      <option value="practice">Practice Level Data</option>
      <option value="individual">Individual Level Data</option>
    </select>
  </div>

  <div class="form-group">
    <label for="medicine">Medicine Prescribed to Audit:</label>
    <select id="medicine">
      <option value="">Select...</option>
      <option value="Medicine A">Medicine A</option>
      <option value="Medicine B">Medicine B</option>
      <option value="Medicine C">Medicine C</option>
      <option value="Medicine D">Medicine D</option>
      <option value="Medicine E">Medicine E</option>
      <option value="Medicine F">Medicine F</option>
    </select>
  </div>

  <div class="form-group">
    <label for="software">Dispensing Software:</label>
    <select id="software">
      <option value="">Select...</option>
      <option value="Best Practice">Best Practice</option>
      <option value="Medical Director Clinical">Medical Director Clinical</option>
      <option value="Medical Director Helix">Medical Director Helix</option>
    </select>
  </div>
  <p id="softwareText"></p>

  <div id="fteInput" style="display:none; margin-top:10px;">
    <label>Total FTE per week within practice:</label>
    <input type="number" id="fte" />
  </div>

  <div id="hoursInput" style="display:none; margin-top:10px;">
    <label>Average number of hours worked per week:</label>
    <input type="number" id="hours" />
  </div>

  <label id="prescribedLabel" style="display:block; margin-top:10px;">Number of [medicine] prescribed in the last 3 months:</label>
  <input type="number" id="prescribed" />

  <h3 style="margin-top:20px;">Which of the following strategies have aided in your ability to deprescribe?</h3>
  <div id="strengths">
    <label><input type="checkbox" value="Strength 1" /> Strength 1</label>
    <!-- ... other strengths ... -->
  </div>

  <h3 style="margin-top:20px;">Which of the following challenges has made deprescribing challenging?</h3>
  <div id="challenges">
    <label><input type="checkbox" value="Challenge 1" /> Challenge 1</label>
    <!-- ... other challenges ... -->
  </div>

  <button id="generateBtn" style="margin-top:20px;">Generate Report</button>

  <hr />
  <div id="report" style="display:none;">
    <h2>Audit Results</h2>
    <div id="printableArea">
      <p id="resultText"></p>
      <p id="resultAnalysis"></p>
      <canvas id="barChart" width="400" height="200"></canvas>
      <p><strong>Impact of facilitators:</strong></p>
      <ul id="strengthOutput"></ul>
      <p><strong>How to overcome barriers:</strong></p>
      <ul id="challengeOutput"></ul>
    </div>
  </div>

  <button id="printButton" style="display:none; margin-top:10px;">Print Report</button>
  <button id="downloadCSV" style="display:none; margin-top:10px;">Download All Data (Admin Only)</button>
</div>

<!-- ✅ JAVASCRIPT SECTION -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  const levelSelect = document.getElementById('practiceLevel');
  const fteInput = document.getElementById('fteInput');
  const hoursInput = document.getElementById('hoursInput');
  const medSelect = document.getElementById('medicine');
  const softwareSelect = document.getElementById('software');
  const generateBtn = document.getElementById('generateBtn');

  function toggleInputs() {
    const val = levelSelect.value;
    fteInput.style.display = val === 'practice' ? 'block' : 'none';
    hoursInput.style.display = val === 'individual' ? 'block' : 'none';
  }
  levelSelect.addEventListener('change', toggleInputs);
  toggleInputs();

  medSelect.addEventListener('change', () => {
    document.getElementById('prescribedLabel').textContent =
      `Number of ${medSelect.value} prescribed in the last 3 months:`;
  });

  softwareSelect.addEventListener('change', () => {
    document.getElementById('softwareText').textContent =
      softwareSelect.value ? `Conduct audit as per procedure within the hyperlinked pdf above for ${softwareSelect.value}` : '';
  });

  generateBtn.addEventListener('click', generateReport);
});

function generateReport() {
  const level = document.getElementById('practiceLevel').value;
  const medicine = document.getElementById('medicine').value;
  const software = document.getElementById('software').value;
  const prescribed = parseFloat(document.getElementById('prescribed').value);
  const fte = parseFloat(document.getElementById('fte').value);
  const manualHours = parseFloat(document.getElementById('hours').value);

  if (!level || !medicine || !software || isNaN(prescribed) || prescribed <= 0 ||
      (level === 'practice' && (isNaN(fte) || fte <= 0)) ||
      (level === 'individual' && (isNaN(manualHours) || manualHours <= 0))) {
    alert('Please complete all required fields with valid numbers.');
    return;
  }

  const hours = level === 'practice' ? fte * 38 : manualHours;
  const rate = prescribed / hours;

  document.getElementById('resultText').textContent =
    `Average Prescribing per Week: ${rate.toFixed(2)}`;

  const analysisEl = document.getElementById('resultAnalysis');
  let text, color;
  if (rate < 10) { text = `On average, the prescribing rate of ${medicine} in your practice is in the bottom 25% based on national data.`; color = 'green'; }
  else if (rate < 20) { text = `On average, the prescribing rate of ${medicine} in your practice is below average based on national data.`; color = 'yellow'; }
  else if (rate < 30) { text = `On average, the prescribing rate of ${medicine} in your practice is above average based on national data.`; color = '
