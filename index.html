<!-- ✅ HTML SECTION -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<div class="container">
  <h1>Medicine Prescribing Audit</h1>
  <div class="form-group">
    <label for="practiceLevel">Type of data: Practice Level vs Individual Data</label>
    <select id="practiceLevel">
      <option value="">Select...</option>
      <option value="practice">Practice Level Data</option>
      <option value="individual">Individual Level Data</option>
    </select>
  </div>

  <div class="form-group">
    <label for="medicine">Medicine Prescribed to Audit:</label>
    <select id="medicine">
      <option value="">Select...</option>
      <option value="Medicine A">Medicine A</option>
      <option value="Medicine B">Medicine B</option>
      <option value="Medicine C">Medicine C</option>
      <option value="Medicine D">Medicine D</option>
      <option value="Medicine E">Medicine E</option>
      <option value="Medicine F">Medicine F</option>
    </select>
  </div>

  <div class="form-group">
    <label for="software">Dispensing Software:</label>
    <select id="software">
      <option value="">Select...</option>
      <option value="Best Practice">Best Practice</option>
      <option value="Medical Director Clinical">Medical Director Clinical</option>
      <option value="Medical Director Helix">Medical Director Helix</option>
    </select>
  </div>
  <p id="softwareText"></p>

  <div id="fteInput" style="display:none;">
    <label>Total FTE per week within practice:</label>
    <input type="number" id="fte" />
  </div>

  <div id="hoursInput" style="display:none;">
    <label>Average number of hours worked per week:</label>
    <input type="number" id="hours" />
  </div>

  <label id="prescribedLabel">Number of [medicine] prescribed in the last 3 months:</label>
  <input type="number" id="prescribed" />

  <h3>Which of the following strategies have aided in your ability to deprescribe?</h3>
  <div id="strengths">
    <label><input type="checkbox" value="Strength 1" /> Strength 1</label>
    <label><input type="checkbox" value="Strength 2" /> Strength 2</label>
    <label><input type="checkbox" value="Strength 3" /> Strength 3</label>
    <label><input type="checkbox" value="Strength 4" /> Strength 4</label>
    <label><input type="checkbox" value="Strength 5" /> Strength 5</label>
    <label><input type="checkbox" value="Strength 6" /> Strength 6</label>
    <label><input type="checkbox" value="None" /> None</label>
  </div>

  <h3>Which of the following challenges has made deprescribing challenging?</h3>
  <div id="challenges">
    <label><input type="checkbox" value="Challenge 1" /> Challenge 1</label>
    <label><input type="checkbox" value="Challenge 2" /> Challenge 2</label>
    <label><input type="checkbox" value="Challenge 3" /> Challenge 3</label>
    <label><input type="checkbox" value="Challenge 4" /> Challenge 4</label>
    <label><input type="checkbox" value="Challenge 5" /> Challenge 5</label>
    <label><input type="checkbox" value="Challenge 6" /> Challenge 6</label>
    <label><input type="checkbox" value="None" /> None</label>
  </div>

  <button onclick="generateReport()">Generate Report</button>

  <hr />
  <div id="report" style="display:none;">
    <h2>Audit Results</h2>
    <div id="printableArea">
      <p id="resultText"></p>
      <p id="resultAnalysis"></p>
      <canvas id="barChart" width="400" height="200"></canvas>
      <p><strong>Impact of facilitators:</strong></p>
      <ul id="strengthOutput"></ul>
      <p><strong>How to overcome barriers:</strong></p>
      <ul id="challengeOutput"></ul>
    </div>
  </div>

  <button id="printButton" onclick="printReport()" style="display:none;">Print Report</button>
  <button id="downloadCSV" onclick="downloadAuditCSV()" style="display:none;">Download All Data (Admin Only)</button>
</div>

<!-- ✅ JAVASCRIPT SECTION -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  const levelSelect = document.getElementById('practiceLevel');
  const fteInput = document.getElementById('fteInput');
  const hoursInput = document.getElementById('hoursInput');
  const medSelect = document.getElementById('medicine');
  const softwareSelect = document.getElementById('software');

  function toggleInputs() {
    const val = levelSelect.value;
    fteInput.style.display = val === 'practice' ? 'block' : 'none';
    hoursInput.style.display = val === 'individual' ? 'block' : 'none';
  }
  toggleInputs();
  levelSelect.addEventListener('change', toggleInputs);

  medSelect.addEventListener('change', () => {
    const med = medSelect.value;
    document.getElementById('prescribedLabel').textContent =
      med ? `Number of ${med} prescribed in the last 3 months:` : 'Number of [medicine] prescribed in the last 3 months:';
  });

  softwareSelect.addEventListener('change', () => {
    document.getElementById('softwareText').textContent =
      softwareSelect.value ? `Conduct audit as per procedure within the hyperlinked pdf above for ${softwareSelect.value}` : '';
  });
});

function generateReport() {
  const level = document.getElementById('practiceLevel').value;
  const medicine = document.getElementById('medicine').value;
  const software = document.getElementById('software').value;
  const prescribed = parseFloat(document.getElementById('prescribed').value);
  const fte = parseFloat(document.getElementById('fte').value);
  const hours = parseFloat(document.getElementById('hours').value);

  if (!level || !medicine || !software || isNaN(prescribed) || prescribed <= 0 ||
      (level === 'practice' && (isNaN(fte) || fte <= 0)) ||
      (level === 'individual' && (isNaN(hours) || hours <= 0))) {
    alert('Please complete all required fields with valid numbers.');
    return;
  }

  let rate = level === 'practice' ? prescribed / fte : prescribed / (hours / 38);
  rate = parseFloat(rate.toFixed(2));

  document.getElementById('resultText').textContent = `Average Prescribing per Week: ${rate}`;
  const analysisEl = document.getElementById('resultAnalysis');
  let text, color;
  if (rate < 10) { text = `On average, the prescribing rate of ${medicine} is in the bottom 25% based on national data.`; color = 'green'; }
  else if (rate < 20) { text = `On average, the prescribing rate of ${medicine} is below average based on national data.`; color = 'yellow'; }
  else if (rate < 30) { text = `On average, the prescribing rate of ${medicine} is above average based on national data.`; color = 'orange'; }
  else { text = `On average, the prescribing rate of ${medicine} is in the top 25% based on national data.`; color = 'red'; }
  analysisEl.textContent = text;
  analysisEl.style.color = color;

  const strengths = [...document.querySelectorAll('#strengths input:checked')].map(i => i.value);
  const challenges = [...document.querySelectorAll('#challenges input:checked')].map(i => i.value);
  document.getElementById('strengthOutput').innerHTML = strengths.includes('None')
    ? '<li>It is known using Strength 1 can accomplish Y..</li>'
    : strengths.map(s => `<li>${s} can result in Y</li>`).join('');
  document.getElementById('challengeOutput').innerHTML = challenges.includes('None')
    ? '<li>Navigating barriers can result in Y</li>'
    : challenges.map(c => `<li>${c} can result in Y</li>`).join('');

  document.getElementById('report').style.display = 'block';
  document.getElementById('printButton').style.display = 'inline-block';
  document.getElementById('downloadCSV').style.display = 'inline-block';

  const ctx = document.getElementById('barChart').getContext('2d');
  if (window.barChartInstance) window.barChartInstance.destroy();
  window.barChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Q1 (10)', 'Median (20)', 'Q3 (30)', 'Your Data'],
      datasets: [{
        data: [10, 20, 30, rate],
        backgroundColor: ['#ccc', '#ccc', '#ccc', color],
        borderColor: ['#999', '#999', '#999', color],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Average Prescribing Rate Based on National Data', font: { size: 16 } },
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: `Average Prescribing Rate for ${medicine} (prescriptions/week)` } }
      }
    }
  });

  const saved = JSON.parse(localStorage.getItem('auditLog')) || [];
  saved.push({
    timestamp: new Date().toISOString(),
    practiceLevel: level,
    medicine,
    software,
    hours: level === 'individual' ? hours : '',
    fte: level === 'practice' ? fte : '',
    prescribed,
    ...Object.fromEntries(strengths.map((s,i) => [`strength_${i+1}`, s])),
    ...Object.fromEntries(challenges.map((c,i) => [`challenge_${i+1}`, c]))
  });
  localStorage.setItem('auditLog', JSON.stringify(saved));
}

function printReport() {
  const printArea = document.getElementById('printableArea');
  document.getElementById('report').style.display = 'block';
  html2canvas(printArea, { scale: 2 }).then(canvas => {
    const data = canvas.toDataURL('image/png');
    const w = window.open('', '', 'width=800,height=1100');
    w.document.write(`
      <html><head><title>Audit Report</title>
      <style>@page{size:A4;margin:20mm;}body{margin:0;padding:0;}img{width:100%;height:auto;display:block;margin:0 auto;}</style>
      </head><body><img src='${data}'/></body></html>`);
    w.document.close(); w.focus(); w.print(); w.close();
  });
}

function downloadAuditCSV() {
  const pwd = prompt('Admin access required. Enter password:');
  if (pwd !== 'admin123') { alert('Access denied.'); return; }
  const data = JSON.parse(localStorage.getItem('auditLog')) || [];
  if (!data.length) return alert('No data to export.');
  const headers = Object.keys(data[0]);
  const rows = data.map(r => headers.map(h => JSON.stringify(r[h] || '')).join(','));
  const csv = [headers.join(','), ...rows].join('
');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'audit-data.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
</script>
