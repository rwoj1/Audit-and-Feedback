
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<div class="container">
  <h1>Medicine Prescribing Audit</h1>

  <!-- Data Type Selection -->
  <div class="form-group">
    <label for="practiceLevel">Type of data: Practice Level vs Individual Data</label>
    <select id="practiceLevel">
      <option value="">Select...</option>
      <option value="practice">Practice Level Data</option>
      <option value="individual">Individual Level Data</option>
    </select>
  </div>

  <!-- Medicine Selection -->
  <div class="form-group">
    <label for="medicine">Medicine Prescribed to Audit</label>
    <select id="medicine">
      <option value="">Select...</option>
      <option value="Medicine A">Medicine A</option>
      <option value="Medicine B">Medicine B</option>
      <option value="Medicine C">Medicine C</option>
      <option value="Medicine D">Medicine D</option>
      <option value="Medicine E">Medicine E</option>
      <option value="Medicine F">Medicine F</option>
    </select>
  </div>

  <!-- Software Selection -->
  <div class="form-group">
    <label for="software">Dispensing Software</label>
    <select id="software">
      <option value="">Select...</option>
      <option value="Best Practice">Best Practice</option>
      <option value="Medical Director Clinical">Medical Director Clinical</option>
      <option value="Medical Director Helix">Medical Director Helix</option>
    </select>
    <p id="softwareText"></p>
  </div>

  <!-- FTE / Hours Inputs -->
  <div id="fteInput" class="form-group" style="display: none;">
    <label for="fte">Total FTE per week within practice</label>
    <input type="number" id="fte" />
  </div>
  <div id="hoursInput" class="form-group" style="display: none;">
    <label for="hours">Average number of hours worked per week</label>
    <input type="number" id="hours" />
  </div>

  <!-- Prescribed Input -->
  <div class="form-group">
    <label id="prescribedLabel" for="prescribed">Number of [medicine] prescribed in the last 3 months</label>
    <input type="number" id="prescribed" />
  </div>

  <!-- Facilitators -->
  <div class="form-group">
    <h3>Which of the following strategies have aided in your ability to deprescribe?</h3>
    <div id="strengths">
      <label><input type="checkbox" value="Strength 1" /> Strength 1</label>
      <label><input type="checkbox" value="Strength 2" /> Strength 2</label>
      <label><input type="checkbox" value="Strength 3" /> Strength 3</label>
      <label><input type="checkbox" value="Strength 4" /> Strength 4</label>
      <label><input type="checkbox" value="Strength 5" /> Strength 5</label>
      <label><input type="checkbox" value="Strength 6" /> Strength 6</label>
      <label><input type="checkbox" value="None" /> None</label>
    </div>
  </div>

  <!-- Challenges -->
  <div class="form-group">
    <h3>Which of the following challenges has made deprescribing challenging?</h3>
    <div id="challenges">
      <label><input type="checkbox" value="Challenge 1" /> Challenge 1</label>
      <label><input type="checkbox" value="Challenge 2" /> Challenge 2</label>
      <label><input type="checkbox" value="Challenge 3" /> Challenge 3</label>
      <label><input type="checkbox" value="Challenge 4" /> Challenge 4</label>
      <label><input type="checkbox" value="Challenge 5" /> Challenge 5</label>
      <label><input type="checkbox" value="Challenge 6" /> Challenge 6</label>
      <label><input type="checkbox" value="None" /> None</label>
    </div>
  </div>

  <!-- Actions -->
  <div class="form-group">
    <button id="generateBtn">Generate Report</button>
  </div>

  <!-- Report Output -->
  <hr />
  <div id="report" style="display: none;">
    <h2>Audit Results</h2>
    <div id="printableArea">
      <p id="resultText"></p>
      <p id="resultAnalysis"></p>
      <canvas id="barChart" width="400" height="200"></canvas>
      <p><strong>Impact of facilitators:</strong></p>
      <ul id="strengthOutput"></ul>
      <p><strong>How to overcome barriers:</strong></p>
      <ul id="challengeOutput"></ul>
    </div>
  </div>

  <!-- Print & Export -->
  <div class="form-group">
    <button id="printButton" style="display: none;">Print Report</button>
    <button id="downloadCSV" style="display: none;">Download All Data (Admin Only)</button>
  </div>
</div>

<!-- âœ… JAVASCRIPT SECTION -->
<script>
// Initialize dropdowns and toggles
window.addEventListener('DOMContentLoaded', () => {
  const levelSelect = document.getElementById('practiceLevel');
  const fteInput = document.getElementById('fteInput');
  const hoursInput = document.getElementById('hoursInput');
  const medSelect = document.getElementById('medicine');
  const softwareSelect = document.getElementById('software');
  const generateBtn = document.getElementById('generateBtn');

  function toggleInputs() {
    fteInput.style.display = levelSelect.value === 'practice' ? 'block' : 'none';
    hoursInput.style.display = levelSelect.value === 'individual' ? 'block' : 'none';
  }

  levelSelect.addEventListener('change', toggleInputs);
  toggleInputs();

  medSelect.addEventListener('change', () => {
    document.getElementById('prescribedLabel').textContent =
      `Number of ${medSelect.value} prescribed in the last 3 months`;
  });

  softwareSelect.addEventListener('change', () => {
    document.getElementById('softwareText').textContent =
      softwareSelect.value ? 
      `Conduct audit as per procedure within the hyperlinked pdf above for ${softwareSelect.value}` : '';
  });

  generateBtn.addEventListener('click', generateReport);
});

// Core report generation
function generateReport() {
  const level = document.getElementById('practiceLevel').value;
  const medicine = document.getElementById('medicine').value;
  const software = document.getElementById('software').value;
  const prescribed = parseFloat(document.getElementById('prescribed').value);
  const fte = parseFloat(document.getElementById('fte').value);
  const hours = parseFloat(document.getElementById('hours').value);

  if (!level || !medicine || !software || isNaN(prescribed) || prescribed <= 0 ||
      (level === 'practice' && (isNaN(fte) || fte <= 0)) ||
      (level === 'individual' && (isNaN(hours) || hours <= 0))) {
    alert('Please complete all required fields.');
    return;
  }

  const h = level === 'practice' ? fte * 38 : hours;
  const rate = prescribed / h;

  document.getElementById('resultText').textContent =
    `Average Prescribing per Week: ${rate.toFixed(2)}`;

  const analysisEl = document.getElementById('resultAnalysis');
  if (rate < 10) analysisEl.textContent = 'On average in bottom 25%';
  else if (rate < 20) analysisEl.textContent = 'On average below average';
  else if (rate < 30) analysisEl.textContent = 'On average above average';
  else analysisEl.textContent = 'On average top 25%';

  document.getElementById('report').style.display = 'block';
  document.getElementById('printButton').style.display = 'inline-block';
  document.getElementById('downloadCSV').style.display = 'inline-block';
}

// Print report
function printReport() {
  html2canvas(document.getElementById('printableArea')).then(canvas => {
    const w = window.open('', '', 'width=800,height=600');
    w.document.write('<html><head><title>Audit Report</title></head><body>');
    w.document.write('<img src="' + canvas.toDataURL() + '"/>');
    w.document.write('</body></html>');
    w.document.close();
    w.print();
    w.close();
  });
}

// Download CSV
function downloadAuditCSV() {
  const pwd = prompt('Admin access required. Enter password:');
  if (pwd !== 'admin123') { alert('Access denied.'); return; }
  const data = JSON.parse(localStorage.getItem('auditLog') || '[]');
  if (!data.length) { alert('No data to export.'); return; }
  const headers = Object.keys(data[0]);
  const rows = data.map(r => headers.map(h => JSON.stringify(r[h] || '')).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'audit-data.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
