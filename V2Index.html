<style>
@media print {
  #barChart {
    max-width: 100% !important;
    height: auto !important;
  }
  canvas {
    page-break-inside: avoid;
    break-inside: avoid;
    display: block;
    margin: 0 auto;
  }
  #printableArea {
    width: 100%;
    max-width: 800px;
    margin: auto;
  }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
  }
}
</style>

<script>
// Prevent duplicate submission for same medicine
function hasSubmittedMedicine(medicine) {
  const log = JSON.parse(localStorage.getItem("auditLog")) || {};
  return log[medicine];
}

function saveEntry(medicine, data) {
  const log = JSON.parse(localStorage.getItem("auditLog")) || {};
  log[medicine] = data;
  localStorage.setItem("auditLog", JSON.stringify(log));
}
function generateReport() {
  const level = document.getElementById("practiceLevel").value;
  const medicine = document.getElementById("medicine").value;
  const software = document.getElementById("software").value;
  const prescribed = parseFloat(document.getElementById("prescribed").value);
  const fte = parseFloat(document.getElementById("fte").value);
  const manualHours = parseFloat(document.getElementById("hours").value);

  if (!level || !medicine || !software || isNaN(prescribed) || prescribed <= 0 ||
    (level === "practice" && (isNaN(fte) || fte <= 0)) ||
    (level === "individual" && (isNaN(manualHours) || manualHours <= 0))) {
    alert("Please complete all required fields with valid numbers.");
    return;
  }

  if (hasSubmittedMedicine(medicine)) {
    alert(`Youâ€™ve already submitted an entry for ${medicine}.`);
    return;
  }

  let weeklyRate = 0;
  if (level === "practice") {
    weeklyRate = prescribed / fte;
  } else {
    weeklyRate = prescribed / (manualHours / 38);
  }

  weeklyRate = weeklyRate / 12;

  const strengths = [...document.querySelectorAll("#strengths input:checked")].map(el => el.value);
  const challenges = [...document.querySelectorAll("#challenges input:checked")].map(el => el.value);

  const entry = {
    timestamp: new Date().toISOString(),
    practiceLevel: level,
    medicine,
    software,
    prescribed,
    fte,
    hours: manualHours,
    weeklyRate: weeklyRate.toFixed(2),
    strengths,
    challenges
  };

  saveEntry(medicine, entry);

  alert(`Submission for ${medicine} recorded successfully.`);
}
}

function printReport() {
  requestAnimationFrame(() => {
    const originalCanvas = document.getElementById("barChart");
    const chartImage = new Image();
    chartImage.src = originalCanvas.toDataURL("image/png");
    chartImage.style.maxWidth = "100%";
    chartImage.style.display = "block";
    chartImage.style.margin = "0 auto";

    const printableArea = document.getElementById("printableArea").cloneNode(true);
    const canvasClone = printableArea.querySelector("#barChart");
    if (canvasClone && canvasClone.parentNode) {
      canvasClone.parentNode.replaceChild(chartImage, canvasClone);
    }

    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Audit Report</title>');
    printWindow.document.write('<style>body { font-family: Arial, sans-serif; margin: 40px; } img { max-width: 100%; height: auto; display: block; margin: 0 auto; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.body.appendChild(printableArea);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  });
}
</script>
